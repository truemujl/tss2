# Интеграция авторизации через Telegram в TssVPN

## Обзор

В рамках данного проекта была реализована полноценная интеграция авторизации через Telegram для VPN-сервиса TssVPN. Это позволяет пользователям быстро и безопасно регистрироваться и входить в систему, используя свой аккаунт Telegram.

## Архитектура решения

### Frontend (Next.js)

#### Компонент TelegramAuth.tsx
- Интеграция Telegram Login Widget
- Получение данных авторизации от Telegram
- Отправка данных на backend для проверки
- Обработка успешной/неуспешной авторизации
- Сохранение JWT токена в localStorage

#### Настройки виджета
- Используется `bot_id`: берется из переменной окружения `NEXT_PUBLIC_TELEGRAM_BOT_ID`
- `button_size`: medium
- `lang`: ru
- `show_avatar`: true
- `radius`: 10
- `request_access`: write (для возможности отправки сообщений пользователю)

### Backend (FastAPI)

#### Маршрут `/auth/telegram/callback`
- Принимает POST-запрос с данными авторизации
- Проверяет подлинность данных через алгоритм проверки хеша Telegram
- Создает нового пользователя или возвращает существующего
- Генерирует и возвращает JWT токен

#### Алгоритм проверки хеша
```python
def verify_telegram_login(auth_data: dict, bot_token: str) -> bool:
    # Получаем хеш из данных
    received_hash = auth_data.pop('hash', '')
    
    # Сортируем параметры по алфавиту
    sorted_pairs = sorted(auth_data.items())
    data_check_string = '\n'.join([f'{k}={v}' for k, v in sorted_pairs])
    
    # Создаем секретный ключ из токена бота
    secret_key = hashlib.sha256(bot_token.encode()).digest()
    
    # Вычисляем хеш
    calculated_hash = hmac.new(secret_key, data_check_string.encode(), hashlib.sha256).hexdigest()
    
    # Сравниваем хеши
    return hmac.compare_digest(calculated_hash, received_hash)
```

#### Модель пользователя
- Используется модель User из существующей системы
- Данные сохраняются в PostgreSQL базе данных
- Пользователь идентифицируется по Telegram ID

### Nginx конфигурация

#### Маршруты
- `/auth/telegram/callback` → проксируется в backend
- Обеспечивает корректную передачу данных между frontend и backend
- Сохраняет заголовки для корректной работы

## Переменные окружения

### Frontend (.env.local)
```
NEXT_PUBLIC_TELEGRAM_BOT_ID=ваш_bot_id
```

### Backend (.env)
```
TELEGRAM_BOT_TOKEN=ваш_токен_бота
```

## Безопасность

### Защита от подделки данных
- Используется официальный алгоритм проверки хеша Telegram
- Данные проверяются на стороне сервера
- Только сервер с правильным токеном бота может проверить хеш

### Защита токенов
- JWT токены используются для аутентификации
- Токены имеют ограниченное время жизни
- Токены хранятся на клиенте безопасно

## Тестирование

### Успешный сценарий
1. Пользователь нажимает кнопку "Войти через Telegram"
2. Открывается окно авторизации Telegram
3. Пользователь подтверждает авторизацию
4. Данные отправляются на backend
5. Backend проверяет хеш и создает/находит пользователя
6. Возвращается JWT токен
7. Пользователь считается авторизованным

### Ошибочный сценарий
1. Если хеш недействителен, возвращается ошибка 400
2. Если данные подделаны, возвращается ошибка 400
3. Пользователь не авторизуется

## Возможные проблемы и решения

### Неустойчивость nginx
В некоторых случаях nginx может возвращать 404 вместо 400 при неверных данных. Это может быть связано с:
- Множественными worker-процессами nginx
- Состоянием docker-сети
- Кэшированием в nginx

Решение: 
- Перезапуск nginx при возникновении проблемы
- Проверка конфигурации и логов nginx
- Мониторинг состояния контейнеров

## Заключение

Интеграция авторизации через Telegram успешно реализована и готова к использованию. Система обеспечивает безопасную и удобную авторизацию для пользователей, используя популярный и надежный метод аутентификации через Telegram.

Основные преимущества:
- Простая и быстрая авторизация
- Высокий уровень безопасности
- Интеграция с существующей системой пользователей
- Совместимость с JWT аутентификацией